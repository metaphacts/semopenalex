<style>
  .soa {
    padding: 2rem;
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }
  .soa .header {
    padding-bottom: 1rem;
  }
  .soa .row {
    margin-left: 0;
    margin-right: 0;
  }
  .cards {
    display: grid;
    grid-template-columns: 2fr 2fr;
    gap: 1rem;
  }
  .card.publication-chart {
    display: flex;
    flex-direction: row;
    gap: 1rem;
    align-items: center;
  }
  .publication-chart > div:first-child {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    justify-content: center;
  }
  .publications__label, .citations__label {
    font-size: 1.3rem;
  }
  .publications__value, .citations__value {
    font-size: 3.2rem;
    font-weight: 700;
  }
  .publications__label, .publications__value {
    color: #000000;
  }
  .citations__label, .citations__value {
    color: var(--soa-color-green);
  }
  .thumbnail {
    max-height: 200px;
    object-fit: contain;
  }
  .search-concepts {
    background: linear-gradient(180deg, #F4F9FF 2.08%, #FFFFFF 50%);
    border-radius: 8px;
    min-height: 300px;
    display: grid;
    grid-template-columns: 50% 50%;
    gap: 1rem;
    padding: 1rem;
  }
  .search-concepts .D3Tree--root {
    overflow: auto;
    max-height: 300px;
    min-height: 300px;
  }
  .search-concepts .broad, .search-concepts .narrow {
    display: flex;
    flex-direction: column;
    justify-content: center;
  }
  .search-concepts .card__title {
    padding-bottom: 0;
    text-align: center;
  }
  .search-concepts .tree {
    padding: 1rem;
  }
  .related-concepts {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    padding-bottom: 1rem;
  }
  .related-concepts > div {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
  }
  .warning {
    display: flex;
    background: rgba(1, 1, 1, 0.05);
    padding: 0.5rem;
    border-radius: 0.5rem;
    text-align: center;
    justify-content: center;
    font-size: 1rem;
    color: var(--soa-color-brown-darker);
  }
</style>
<div class="soa">
 
  <div class="row">
    <div class="col-sm-12 col-lg-1">
      <mp-resource-thumbnail iri="{{page-resource}}" class='thumbnail' no-image-uri='/assets/images/no-photos.png' style='max-width:96px;border-radius:4px;'>
        <mp-resource-thumbnail-fallback>
        </mp-resource-thumbnail-fallback>
      </mp-resource-thumbnail>
    </div>
    <div class="col-sm-12 col-lg-11">
      <div style="margin-top: 8px">
        <h2><mp-label iri='{{page-resource}}'></mp-label></h2>
        <semantic-query query='
          SELECT DISTINCT ?parent  WHERE { 
            BIND ( <{{page-resource}}> as ?concept)
            ?concept skos:broader|^skos:narrower ?parent . 
          
          } LIMIT 20
          ' template='{{> tmp}}' >
          <template id="tmp">
            {{#if bindings.length}}
              <div style="margin-top:4px">
              Broader concepts:
              {{#each bindings}}
                {{#if parent}}
                  <semantic-link iri="{{parent.value}}"></semantic-link>{{#unless @last}}, {{/unless}}
                {{/if}}
              {{/each}}
              </div>
            {{/if}}
          </template>
        </semantic-query>
        <semantic-query query='
          SELECT DISTINCT ?children  WHERE { 
            BIND ( <{{page-resource}}> as ?concept)
            ?concept skos:narrower|^skos:broader ?children .
          
          }  LIMIT 20
          ' template='{{> tmp}}'>
          <template id="tmp">
            {{#if bindings.length}}
              <div style="margin-top:4px">
            
                Narrower concepts:
                {{#each bindings}}

                  {{#if children}}
                    <semantic-link iri="{{children.value}}"></semantic-link>{{#unless @last}}, {{/unless}}
                  {{/if}}
                {{/each}}
              
              </div>
            {{/if}}
          </template>
        </semantic-query>
      </div>
    </div>

  </div>
  <div class="row cards" style="grid-template-columns: 1fr;">
    <div class="card">
      <div class="row">
        <div class="col-2">
          <div class="publications__label">Publications
            <span style="cursor:pointer">
              <mp-popover>
                <mp-popover-trigger placement="top" trigger='["hover","focus"]'>
                  <span class="material-symbols-outlined">error</span>
                </mp-popover-trigger>
                <mp-popover-content>
                  <div>Due to the limited resources on the server, we're accurately unable to count the exact number of publications.</div>
                </mp-popover-content>
              </mp-popover>
            </span>
          </div>
          <semantic-query query='
            SELECT (COUNT (?publication) as ?count) WHERE {
              { SELECT * {
                ?publication a soa:Work .
                <<?publication <https://semopenalex.org/ontology/hasSustainableDevelopmentGoal> <{{page-resource}}> >> soa:score ?score .
              } LIMIT 1000 }
            }' template='{{>tmp}}' no-result-template='<div class="publications__value">0</div>'>
            <template id="tmp">
              {{#each bindings}}
               
                  <div class="publications__value">{{count.value}}</div>
                 
              {{/each}}
            </template>
          </semantic-query>
       
          <div class="citations__label">Citation
            <span style="cursor:pointer">
              <mp-popover>
                <mp-popover-trigger placement="top" trigger='["hover","focus"]'>
                  <span class="material-symbols-outlined">error</span>
                </mp-popover-trigger>
                <mp-popover-content>
                  <div>Due to the limited resources on the server, we're accurately unable to count the exact number of citations.</div>
                </mp-popover-content>
              </mp-popover>
            </span>
          </div>
          <semantic-query query='
            SELECT (SUM (?citations) as ?count) WHERE {
              { SELECT * {
                ?publication a soa:Work .
                <<?publication <https://semopenalex.org/ontology/hasSustainableDevelopmentGoal> <{{page-resource}}> >> soa:score ?score .
                ?publication soa:citedByCount ?citations .
              
              } LIMIT 1000 }
            }
          ' template="{{> tmp}}" no-result-template='<div class="publications__value">0</div>'>
            <template id="tmp">
              {{#each bindings}}
                <div class="citations__value">{{count.value}}</div>
              {{/each}}
            </template>
          </semantic-query>
        </div>
        <div class="col-10">
          <semantic-chart type="bar"  query='
             SELECT ?year (max(?cited) as ?cited) (max(?work) as ?work)    {
                {
                  SELECT ?year (COUNT (?publication) as ?work)  {
                    {
                      SELECT * {
                        ?publication a soa:Work .
                        <<?publication <https://semopenalex.org/ontology/hasSustainableDevelopmentGoal> <{{page-resource}}> >> soa:score ?score .
                        ?publication fabio:hasPublicationYear ?year .
                        FILTER (?score >= 0.5 && ?year >= 2014)
                      } LIMIT 1000
                    }
                  } GROUP BY ?year ORDER BY ASC(?year)
                } UNION {
                        
                  SELECT ?year (SUM (?citations) as ?cited)  {
                    {
                      SELECT * {
                        ?publication a soa:Work .
                        <<?publication <https://semopenalex.org/ontology/hasSustainableDevelopmentGoal> <{{page-resource}}> >> soa:score ?score .
                          ?publication soa:citedByCount ?citations .
                          ?publication fabio:hasPublicationYear ?year .
                        FILTER (?score >= 0.5 && ?year >= 2014 )
                      } LIMIT 1000
                    }
                  } GROUP BY ?year ORDER BY ASC(?year)
                      
                }
                      
            }GROUP BY ?year
            ' 
            sets='[
            {"dataSetName": "Publications", "category": "year", "value": "work"},
            {"dataSetName": "Citations", "category": "year", "value": "cited"}
          ]'
            styles='[{
              "provider": "highcharts",
              "style": {
                "yAxis": [{"opposite": true}, {"opposite": false}],
                "series": [
                  {"type": "column", "name": "Publications", "yAxis": 1},
                  {"type": "line", "name": "Citations", "yAxis": 0}
                ]
        
              }
            }]'
            dimensions='{"height": 200}'
          >
          </semantic-chart>
         
        </div>
      </div>
    </div>
   
  </div>

  <div class="row related-concepts">
    <div class="card__title">RELATED CONCEPTS</div>
    <div>
      <semantic-query query='
        SELECT ?relatedConcept WHERE {
          BIND(<{{page-resource}}> as ?concept)
          ?concept <http://www.w3.org/2004/02/skos/core#related> ?relatedConcept .
        } LIMIT 20
      ' template='{{>tmp}}' no-result-template='<span>No related concepts found.</span>'>
        <template id="tmp">
          {{#each bindings}}
             <span class="badge badge-secondary" >
              <semantic-link iri="{{relatedConcept.value}}"></semantic-link>&nbsp;
            </span> 
          {{/each}}
        </template>
      </semantic-query>
    </div>
  </div>


  <div class="row card publications">
    <mp-event-target-template-render id="publications" template='{{>tmp}}'>
      <template id="tmp">
        <div class="publications__header">
          <div class="card__title">PUBLICATIONS</div>
          <div class="buttons">
            <mp-event-trigger type='Component.TemplateUpdate' data='{"sort":"DESC (?cited)", "all": "{{all}}"}' targets='["publications"]'>
              <button class='{{#unless sort}}selected{{/unless}}{{#ifCond sort "===" "DESC (?cited)"}}selected{{/ifCond}}'>Most cited</button>
            </mp-event-trigger>
            <mp-event-trigger type='Component.TemplateUpdate' data='{"sort":"DESC (?publicationYear)", "all": "{{all}}"}' targets='["publications"]'>
              <button class='{{#ifCond sort "===" "DESC (?publicationYear)"}}selected{{/ifCond}}'>Latest</button>
            </mp-event-trigger>
          </div>
        </div>
        <semantic-table query='
          SELECT ?title ?publication ?cited ?publicationYear ?publisher ?volume ?issue (group_concat(DISTINCT ?name; separator = ", ") as ?authors) (COUNT(?publication) as ?count) WHERE {
            {
              SELECT * WHERE {
                <<?publication <https://semopenalex.org/ontology/hasSustainableDevelopmentGoal> <{{page-resource}}> >> soa:score ?score .
              }
              LIMIT 1001
            }
            FILTER (?score >= 0.5)
            
            ?publication <http://purl.org/dc/terms/creator> ?author . 
            ?publication <http://purl.org/dc/terms/title> ?title .
            ?author <http://xmlns.com/foaf/0.1/name> ?name .
            ?publication <https://semopenalex.org/ontology/citedByCount> ?cited .
            OPTIONAL {
              ?publication <https://semopenalex.org/ontology/hasHostVenue> ?hostVenue .
              ?hostVenue <https://semopenalex.org/ontology/hasVenue> ?venue .
              ?venue <http://purl.org/dc/terms/publisher> ?publisher .
            }
            OPTIONAL {
              ?publication <https://semopenalex.org/ontology/hasVolume> ?volume .
            }
            OPTIONAL {
              ?publication <https://semopenalex.org/ontology/hasIssue> ?issue .
            }
            OPTIONAL {
              ?publication <http://purl.org/spar/fabio/hasPublicationYear> ?publicationYear .  
            }
          } 
          GROUP BY ?title ?publication ?publicationYear ?cited ?publisher ?volume ?issue
          ORDER BY {{#if sort}}{{sort}}{{else}}DESC(?cited){{/if}}
          LIMIT {{#ifCond all "===" "true"}}1001{{else}}10{{/ifCond}}' 
          number-of-displayed-rows="10"
          tuple-template='
            <div class="publication">
              <div class="publication__top">
                <semantic-link iri="{{publication.value}}">
                  <div class="publication__title">{{title.value}}</div>
                </semantic-link>
                <div class="publication__author" style="width: 100%;">
                  <mp-text-truncate truncate="..." style="width: inherit;">
                    By {{authors.value}}
                  </mp-text-truncate>
                </div>
                <div class="publication__info">
                  {{#if publisher}}{{publisher.value}}, {{/if}}
                  {{#if volume}}Volume {{volume.value}}, {{/if}}
                  {{#if issue}}Issue {{issue.value}}, {{/if}}
                  {{publicationYear.value}}
                </div>
              </div>
              <div class="publication__bottom">
                <div class="publication__year">{{publicationYear.value}}</div>
                <div class="publication__citation">
                  <div class="publication__citation-icon"></div>
                  <div class="publication__citation-value">{{cited.value}}</div>
                </div>
              </div>
            </div>
        ' options='{"showFilter":false}'></semantic-table>
        <mp-event-trigger type='Component.TemplateUpdate' data='{"all": "true", "sort": "{{sort}}"}' targets='["publications"]'>
          <button class='publications__foot-button {{#ifCond all "===" "true"}}publications__foot-button--disabled{{/ifCond}}'>ALL PUBLICATIONS</button>
        </mp-event-trigger>
        <semantic-query query='SELECT (COUNT(*) as ?count) WHERE {
          {
            SELECT * WHERE {
              ?publication <https://semopenalex.org/ontology/hasConcept> <{{page-resource}}> .  
            }
            LIMIT 1001
          }
        }' template='{{> tmp}}'>
          <template id="tmp">
            {{#each bindings}}
              {{#ifCond count.value ">=" 1000}}<div class="warning">The table above is a preview of 1000 publications. However, the absolute number of publications seems to be larger and some publications might be missing.</div>{{/ifCond}}
            {{/each}}
          </template>
        </semantic-query>
      </template>
    </mp-event-target-template-render>
  </div>
</div>